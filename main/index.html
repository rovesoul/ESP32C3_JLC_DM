<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å‘çƒ­ç‰‡æ§åˆ¶ç³»ç»Ÿ</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 1rem;
        color: #333;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      .header {
        text-align: center;
        color: white;
        margin-bottom: 2rem;
      }

      .header h1 {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
      }

      .header p {
        font-size: 1rem;
        opacity: 0.9;
      }

      /* å¡ç‰‡æ ·å¼ */
      .card {
        background: white;
        border-radius: 16px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }

      .card-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: #667eea;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #f0f0f0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .card-title::before {
        content: "";
        width: 4px;
        height: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 2px;
      }

      /* è¡¨å•ç½‘æ ¼å¸ƒå±€ */
      .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1rem;
      }

      /* é¡¶éƒ¨é…ç½®å’Œæ§åˆ¶åŒºåŸŸå¹¶æ’å¸ƒå±€ */
      .top-section {
        display: grid;
        grid-template-columns: 1.2fr 0.8fr;
        gap: 1rem;
        margin-bottom: 1rem;
      }

      .form-section {
        background: #f8f9fa;
        padding: 0.3rem;
        border-radius: 6px;
      }

      .form-section-title {
        font-size: 0.75rem;
        font-weight: 600;
        color: #555;
        margin-bottom: 0.25rem;
      }

      .form-group {
        margin-bottom: 0.25rem;
      }

      .form-group:last-child {
        margin-bottom: 0;
      }

      label {
        display: block;
        margin-bottom: 0.2rem;
        font-weight: 500;
        color: #666;
        font-size: 0.75rem;
      }

      input {
        width: 100%;
        padding: 0.3rem 0.4rem;
        border: 2px solid #e0e0e0;
        border-radius: 4px;
        font-size: 0.8rem;
        transition: all 0.3s;
        background: white;
      }

      input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      /* æŒ‰é’®æ ·å¼ */
      .btn-submit {
        width: 100%;
        padding: 0.4rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      }

      .btn-submit:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
      }

      .btn-submit:active {
        transform: translateY(0);
      }

      /* æ§åˆ¶æŒ‰é’® */
      .control-section {
        text-align: center;
        padding: 0.3rem;
      }

      .power-btn {
        width: 130px;
        height: 130px;
        border-radius: 50%;
        border: none;
        font-size: 1rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        position: relative;
        overflow: hidden;
      }

      .power-btn::before {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.3);
        transform: translate(-50%, -50%);
        transition: width 0.6s, height 0.6s;
      }

      .power-btn:hover::before {
        width: 300px;
        height: 300px;
      }

      .power-btn.off {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
      }

      .power-btn.on {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          box-shadow: 0 10px 30px rgba(79, 172, 254, 0.4);
        }
        50% {
          box-shadow: 0 10px 40px rgba(79, 172, 254, 0.6);
        }
      }

      .status-badge {
        display: inline-block;
        margin-top: 1rem;
        padding: 0.5rem 1.5rem;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.95rem;
      }

      .status-badge.off {
        background: #ffebee;
        color: #c62828;
      }

      .status-badge.on {
        background: #e3f2fd;
        color: #1565c0;
      }

      /* æ—¶é—´æ˜¾ç¤ºåŒºåŸŸ */
      .time-display {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
      }

      .time-card {
        padding: 0.4rem;
        border-radius: 6px;
        text-align: center;
        transition: all 0.3s;
      }

      .time-card.timer {
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
      }

      .time-card.running {
        background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
      }

      .time-label {
        font-size: 0.9rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        opacity: 0.8;
      }

      .timer .time-label {
        color: #1565c0;
      }

      .running .time-label {
        color: #2e7d32;
      }

      .time-value {
        font-size: 1rem;
        font-weight: 700;
        font-family: "Courier New", monospace;
        letter-spacing: 2px;
      }

      .timer .time-value {
        color: #0d47a1;
      }

      .running .time-value {
        color: #1b5e20;
      }

      /* æ•°å€¼æ˜¾ç¤º */
      .values-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 0.75rem;
      }

      .value-item {
        background: #f8f9fa;
        padding: 0.75rem;
        border-radius: 10px;
        text-align: center;
        transition: all 0.3s;
      }

      .value-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .value-label {
        font-size: 0.8rem;
        color: #888;
        margin-bottom: 0.3rem;
        font-weight: 500;
      }

      .value-data {
        font-size: 1.1rem;
        font-weight: 700;
        color: #333;
      }

      /* PIDç»„åˆæ ·å¼ */
      .pid-group {
        background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
        border: 2px solid #667eea;
      }

      .pid-values {
        display: flex;
        justify-content: space-around;
        align-items: center;
        gap: 0.5rem;
      }

      .pid-values span {
        font-size: 0.85rem;
        color: #666;
        font-weight: 500;
      }

      .pid-values b {
        color: #333;
        font-size: 1rem;
        font-weight: 700;
      }

      /* å›¾è¡¨å®¹å™¨ */
      .charts-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 0.5rem;
        margin-top: 1rem;
      }

      .chart-wrapper {
        background: white;
        padding: 0.5rem;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        height: 350px; /* å¢å¤§å›¾è¡¨é«˜åº¦ */
      }

      canvas {
        width: 100% !important;
        height: 100% !important;
        min-height: 350px !important;
      }

      /* å“åº”å¼ */
      @media (max-width: 768px) {
        .header h1 {
          font-size: 1.5rem;
        }

        .power-btn {
          width: 100px;
          height: 100px;
          font-size: 0.85rem;
        }

        .time-value {
          font-size: 0.9rem;
        }

        .form-grid {
          grid-template-columns: 1fr;
        }

        .top-section {
          grid-template-columns: 1fr;
        }

        .pid-values {
          flex-direction: column;
          gap: 0.3rem;
        }

        .pid-values span {
          font-size: 0.8rem;
        }
      }

      /* éšè—ç±» */
      .hidden {
        display: none !important;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- å¤´éƒ¨ -->
      <div class="header">
        <h1>ğŸ”¥ å‘çƒ­ç‰‡æ™ºèƒ½æ§åˆ¶ç³»ç»Ÿ</h1>
        <p>PIDæ§æ¸© Â· æ™ºèƒ½å®šæ—¶ Â· å®æ—¶ç›‘æ§</p>
      </div>

      <!-- é¡¶éƒ¨åŒºåŸŸï¼šé…ç½®å’Œæ§åˆ¶å¹¶æ’ -->
      <div class="top-section">
        <!-- é…ç½®å¡ç‰‡ -->
        <div class="card">
          <div class="card-title">âš™ï¸ ç³»ç»Ÿé…ç½®</div>
          <form id="configForm">
            <div class="form-grid">
              <!-- PIDå‚æ•° -->
              <div class="form-section">
                <div class="form-section-title">ğŸ“Š PIDå‚æ•°</div>
                <div class="form-group">
                  <label for="P_value">æ¯”ä¾‹ç³»æ•° (P)</label>
                  <input
                    type="number"
                    id="P_value"
                    step="0.01"
                    value="0.0"
                    placeholder="0.0"
                  />
                </div>
                <div class="form-group">
                  <label for="I_value">ç§¯åˆ†ç³»æ•° (I)</label>
                  <input
                    type="number"
                    id="I_value"
                    step="0.01"
                    value="0.0"
                    placeholder="0.0"
                  />
                </div>
                <div class="form-group">
                  <label for="D_value">å¾®åˆ†ç³»æ•° (D)</label>
                  <input
                    type="number"
                    id="D_value"
                    step="0.01"
                    value="0.0"
                    placeholder="0.0"
                  />
                </div>
              </div>

              <!-- æ¸©åº¦å’Œé£æ‰‡ -->
              <div class="form-section">
                <div class="form-section-title">ğŸŒ¡ï¸ æ¸©åº¦ä¸é£æ‰‡</div>
                <div class="form-group">
                  <label for="TARGET_TEMP">ç›®æ ‡æ¸©åº¦ (Â°C)</label>
                  <input
                    type="number"
                    id="TARGET_TEMP"
                    step="0.1"
                    value="0.0"
                    placeholder="35.0"
                  />
                </div>
                <div class="form-group">
                  <label for="FAN_SPEED">é£æ‰‡è½¬é€Ÿ (%)</label>
                  <input
                    type="number"
                    id="FAN_SPEED"
                    step="1"
                    min="0"
                    max="100"
                    value="100"
                    placeholder="100"
                  />
                </div>
              </div>

              <!-- å®šæ—¶å™¨ -->
              <div class="form-section">
                <div class="form-section-title">â±ï¸ å®šæ—¶è®¾ç½®</div>
                <div class="form-group">
                  <label for="TIMER_HOURS">å®šæ—¶æ—¶é•¿ (å°æ—¶)</label>
                  <input
                    type="number"
                    id="TIMER_HOURS"
                    step="0.01"
                    min="0"
                    max="24"
                    value="0.0"
                    placeholder="0è¡¨ç¤ºå…³é—­å®šæ—¶å™¨ï¼Œæœ€å°0.01å°æ—¶(36ç§’)"
                  />
                </div>
              </div>
            </div>
            <button type="submit" class="btn-submit">ğŸ’¾ ä¿å­˜é…ç½®</button>
          </form>
        </div>

        <!-- æ§åˆ¶å¡ç‰‡ -->
        <div class="card">
          <div class="card-title">ğŸ® ç³»ç»Ÿæ§åˆ¶</div>
          <div class="control-section">
            <button id="toggleSwitch" class="power-btn off">
              <span id="btnText">ç‚¹å‡»å¯åŠ¨</span>
            </button>
            <br />
            <span
              id="currentStatus"
              class="status-badge off"
              style="display: inline-block"
              >ç³»ç»Ÿå·²å…³é—­</span
            >
          </div>

          <!-- æ—¶é—´æ˜¾ç¤º -->
          <div class="time-display">
            <div class="time-card timer hidden" id="timerDisplay">
              <div class="time-label">â±ï¸ å®šæ—¶å€’è®¡æ—¶</div>
              <div class="time-value" id="timerCountdown">00:00:00</div>
            </div>
            <div class="time-card running hidden" id="runningTimeDisplay">
              <div class="time-label">â° ç³»ç»Ÿè¿è¡Œæ—¶é—´</div>
              <div class="time-value" id="runningTime">00:00:00</div>
            </div>
          </div>
        </div>
      </div>

      <!-- ç›‘æ§æ•°æ®å¡ç‰‡ -->
      <div class="card">
        <div class="card-title">ğŸ“ˆ å®æ—¶ç›‘æ§</div>
        <div class="values-grid">
          <div class="value-item pid-group">
            <!-- <div class="value-label"></div> -->
            <div class="pid-values">
              <span>P: <b id="current_P">0.00</b></span>
              <span>I: <b id="current_I">0.00</b></span>
              <span>D: <b id="current_D">0.00</b></span>
            </div>
          </div>
          <div class="value-item">
            <div class="value-label">ç›®æ ‡æ¸©åº¦</div>
            <div class="value-data" id="current_TARGET_TEMP">0.0Â°C</div>
          </div>
          <div class="value-item">
            <div class="value-label">NTCæ¸©åº¦</div>
            <div class="value-data" id="current_ntcTemp">0.0Â°C</div>
          </div>
          <div class="value-item">
            <div class="value-label">DHTæ¸©åº¦</div>
            <div class="value-data" id="current_dhtTemp">0.0Â°C</div>
          </div>
          <div class="value-item">
            <div class="value-label">DHTæ¹¿åº¦</div>
            <div class="value-data" id="current_dhtHumidity">0.0%</div>
          </div>
          <div class="value-item">
            <div class="value-label">å‘çƒ­ç‰‡PWM</div>
            <div class="value-data" id="current_pwmPercent">0.0%</div>
          </div>
          <div class="value-item">
            <div class="value-label">é£æ‰‡è½¬é€Ÿé…ç½®</div>
            <div class="value-data" id="current_fanSpeed">0%</div>
          </div>
          <div class="value-item">
            <div class="value-label">é£æ‰‡çŠ¶æ€</div>
            <div class="value-data" id="current_fanStatus">--</div>
          </div>
          <div class="value-item">
            <div class="value-label">é£æ‰‡å®é™…PWM</div>
            <div class="value-data" id="current_fanActualPwm">0%</div>
          </div>
        </div>

        <!-- å›¾è¡¨ -->
        <div class="charts-container">
          <div class="chart-wrapper">
            <canvas id="temperatureChart"></canvas>
          </div>
          <div class="chart-wrapper">
            <canvas id="humidityChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      // ========== å®šæ—¶å™¨ç›¸å…³å˜é‡ ==========
      let lastTimerRemaining = -1;

      // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º HH:MM:SS
      function formatTime(totalSeconds) {
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;
        return `${String(hours).padStart(2, "0")}:${String(minutes).padStart(
          2,
          "0"
        )}:${String(seconds).padStart(2, "0")}`;
      }

      // æ›´æ–°å®šæ—¶å™¨æ˜¾ç¤º
      function updateTimerDisplay(seconds) {
        document.getElementById("timerCountdown").textContent =
          formatTime(seconds);
      }

      // æäº¤é…ç½®
      document
        .getElementById("configForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();
          const P = document.getElementById("P_value").value;
          const I = document.getElementById("I_value").value;
          const D = document.getElementById("D_value").value;
          const TARGET_TEMP = document.getElementById("TARGET_TEMP").value;
          const FAN_SPEED = document.getElementById("FAN_SPEED").value;
          const TIMER_HOURS = document.getElementById("TIMER_HOURS").value;

          const jsonBody = `{"P":${parseFloat(P)},"I":${parseFloat(
            I
          )},"D":${parseFloat(D)},"TARGET_TEMP":${parseFloat(
            TARGET_TEMP
          )},"fanSpeed":${parseFloat(FAN_SPEED)},"timerHours":${parseFloat(
            TIMER_HOURS
          )}}`;

          const response = await fetch("/config", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: jsonBody,
          });

          if (response.ok) {
            alert("âœ… é…ç½®ä¿å­˜æˆåŠŸï¼");
          } else {
            alert("âŒ é…ç½®ä¿å­˜å¤±è´¥ï¼");
          }
        });

      const temperatureData = {
        labels: [],
        datasets: [
          {
            label: "NTCæ¸©åº¦",
            data: [],
            borderColor: "rgba(255, 99, 132, 1)",
            backgroundColor: "rgba(255, 99, 132, 0.2)",
            fill: true,
            tension: 0.4,
          },
          {
            label: "DHTæ¸©åº¦",
            data: [],
            borderColor: "rgba(54, 162, 235, 1)",
            backgroundColor: "rgba(54, 162, 235, 0.2)",
            fill: true,
            tension: 0.4,
          },
        ],
      };

      const humidityData = {
        labels: [],
        datasets: [
          {
            label: "DHTæ¹¿åº¦",
            data: [],
            borderColor: "rgba(75, 192, 192, 1)",
            backgroundColor: "rgba(75, 192, 192, 0.2)",
            fill: true,
            tension: 0.4,
          },
        ],
      };

      const temperatureChart = new Chart(
        document.getElementById("temperatureChart"),
        {
          type: "line",
          data: temperatureData,
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "top",
                labels: {
                  font: {
                    size: 10,
                    family: "'Segoe UI', 'Microsoft YaHei', sans-serif",
                  },
                  usePointStyle: true,
                  boxWidth: 6,
                  padding: 6,
                  borderRadius: 4,
                },
              },
              title: {
                display: true,
                text: "æ¸©åº¦æ›²çº¿(Â°C)",
                font: {
                  size: 12,
                  weight: "600",
                  family: "'Segoe UI', 'Microsoft YaHei', sans-serif",
                },
                padding: {
                  top: 5,
                  bottom: 5,
                },
              },
            },
            scales: {
              x: {
                title: {
                  display: true,
                  text: "",
                  font: {
                    size: 10,
                  },
                },
                ticks: {
                  font: {
                    size: 9,
                  },
                },
              },
              y: {
                title: {
                  display: true,
                  text: "",
                  font: {
                    size: 10,
                  },
                },
                ticks: {
                  font: {
                    size: 9,
                  },
                },
              },
            },
          },
        }
      );

      const humidityChart = new Chart(
        document.getElementById("humidityChart"),
        {
          type: "line",
          data: humidityData,
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "top",
                labels: {
                  font: {
                    size: 10,
                    family: "'Segoe UI', 'Microsoft YaHei', sans-serif",
                  },
                  usePointStyle: true,
                  boxWidth: 6,
                  padding: 6,
                  borderRadius: 4,
                },
              },
              title: {
                display: true,
                text: "æ¹¿åº¦æ›²çº¿(%)",
                font: {
                  size: 12,
                  weight: "600",
                  family: "'Segoe UI', 'Microsoft YaHei', sans-serif",
                },
                padding: {
                  top: 5,
                  bottom: 5,
                },
              },
            },
            scales: {
              x: {
                title: {
                  display: true,
                  text: "",
                  font: {
                    size: 10,
                  },
                },
                ticks: {
                  font: {
                    size: 9,
                  },
                },
              },
              y: {
                title: {
                  display: true,
                  text: "",
                  font: {
                    size: 10,
                  },
                },
                ticks: {
                  font: {
                    size: 9,
                  },
                },
              },
            },
          },
        }
      );

      // è·å–å½“å‰å€¼
      async function getCurrentValues() {
        const response = await fetch("/values");
        const data = await response.json();

        const now = new Date().toLocaleTimeString();

        if (temperatureData.labels.length > 100) {
          temperatureData.labels.shift();
          temperatureData.datasets[0].data.shift();
          temperatureData.datasets[1].data.shift();
        }

        if (humidityData.labels.length > 100) {
          humidityData.labels.shift();
          humidityData.datasets[0].data.shift();
        }

        temperatureData.labels.push(now);
        temperatureData.datasets[0].data.push(data.ntcTemp);
        temperatureData.datasets[1].data.push(data.dhtTemp);

        humidityData.labels.push(now);
        humidityData.datasets[0].data.push(data.dhtHumidity);

        temperatureChart.update();
        humidityChart.update();

        document.getElementById("current_P").textContent = data.P.toFixed(2);
        document.getElementById("current_I").textContent = data.I.toFixed(2);
        document.getElementById("current_D").textContent = data.D.toFixed(2);
        document.getElementById("current_TARGET_TEMP").textContent =
          data.TARGET_TEMP.toFixed(1) + "Â°C";
        document.getElementById("current_ntcTemp").textContent =
          data.ntcTemp.toFixed(1) + "Â°C";
        document.getElementById("current_pwmPercent").textContent =
          data.pwmPercent.toFixed(1) + "%";
        document.getElementById("current_dhtTemp").textContent =
          data.dhtTemp.toFixed(1) + "Â°C";
        document.getElementById("current_dhtHumidity").textContent =
          data.dhtHumidity.toFixed(1) + "%";
        document.getElementById("current_fanSpeed").textContent =
          data.fanSpeed.toFixed(0) + "%";

        // æ›´æ–°é£æ‰‡çŠ¶æ€å’Œå®é™…PWM
        const fanStatusEl = document.getElementById("current_fanStatus");
        if (data.fanRunning === true) {
          fanStatusEl.textContent = "è¿è¡Œä¸­";
          fanStatusEl.style.color = "#2e7d32"; // ç»¿è‰²
        } else {
          fanStatusEl.textContent = "å·²åœæ­¢";
          fanStatusEl.style.color = "#c62828"; // çº¢è‰²
        }
        document.getElementById("current_fanActualPwm").textContent =
          data.fanActualPwm.toFixed(0) + "%";

        // æ›´æ–°ç³»ç»Ÿè¿è¡Œæ—¶é—´æ˜¾ç¤º
        if (data.systemRunningSeconds > 0) {
          document.getElementById("runningTime").textContent = formatTime(
            data.systemRunningSeconds
          );
          document
            .getElementById("runningTimeDisplay")
            .classList.remove("hidden");
        } else {
          document.getElementById("runningTimeDisplay").classList.add("hidden");
        }

        // æ›´æ–°ç³»ç»Ÿå¼€å…³çŠ¶æ€ï¼ˆåŒæ­¥å¤šå®¢æˆ·ç«¯çŠ¶æ€ï¼‰
        if (data.isOPEN !== undefined) {
          const newIsOPEN = data.isOPEN === "true" || data.isOPEN === true;
          if (newIsOPEN !== isOPEN) {
            isOPEN = newIsOPEN;
            updateUIState();
          }
        }

        // æ›´æ–°å®šæ—¶å™¨å€’è®¡æ—¶æ˜¾ç¤º
        // å¦‚æœé…ç½®äº†å®šæ—¶å™¨ï¼ˆtimerHours > 0ï¼‰å¹¶ä¸”ç³»ç»Ÿå·²å¯åŠ¨ï¼Œæ˜¾ç¤ºå€’è®¡æ—¶
        if (data.timerHours > 0 && isOPEN) {
          if (data.timerRemaining >= 0) {
            document.getElementById("timerDisplay").classList.remove("hidden");
            updateTimerDisplay(data.timerRemaining);
            lastTimerRemaining = data.timerRemaining;
          }
        } else {
          document.getElementById("timerDisplay").classList.add("hidden");
          if (!isOPEN) {
            lastTimerRemaining = -1;
          }
        }

        // æ³¨æ„: å€’è®¡æ—¶ç»“æŸç”±åç«¯å®šæ—¶å™¨å›è°ƒè‡ªåŠ¨å¤„ç†,å‰ç«¯æ— éœ€é¢å¤–æ“ä½œ
        // åç«¯å®šæ—¶å™¨åˆ°æœŸåä¼šè‡ªåŠ¨è®¾ç½® is_OPEN = false,å‰ç«¯ä¼šé€šè¿‡è½®è¯¢æ£€æµ‹åˆ°çŠ¶æ€å˜åŒ–
      }

      // é¡µé¢åŠ è½½æ—¶è·å–å½“å‰ PID æ•°æ®å¹¶è®¾ç½®é»˜è®¤å€¼
      async function setDefaultValues() {
        const response = await fetch("/values");
        const data = await response.json();
        document.getElementById("P_value").value = data.P.toFixed(2);
        document.getElementById("I_value").value = data.I.toFixed(2);
        document.getElementById("D_value").value = data.D.toFixed(2);
        document.getElementById("TARGET_TEMP").value =
          data.TARGET_TEMP.toFixed(1);
        document.getElementById("FAN_SPEED").value = data.fanSpeed.toFixed(0);
        document.getElementById("TIMER_HOURS").value =
          data.timerHours.toFixed(2);
      }

      // è°ƒç”¨å‡½æ•°è®¾ç½®é»˜è®¤å€¼
      setDefaultValues();

      // å®šæ—¶åˆ·æ–°ï¼ˆä½†ä¸ç«‹å³è°ƒç”¨ï¼Œç­‰å¾…é¡µé¢åŠ è½½å®Œæˆåç”± getToggleState è§¦å‘ï¼‰
      setInterval(getCurrentValues, 1000);

      const toggleButton = document.getElementById("toggleSwitch");
      const btnText = document.getElementById("btnText");
      let isOPEN = false;

      // æ›´æ–°UIçŠ¶æ€çš„å‡½æ•°
      function updateUIState() {
        const statusBadge = document.getElementById("currentStatus");
        if (isOPEN) {
          toggleButton.classList.remove("off");
          toggleButton.classList.add("on");
          btnText.textContent = "æ­£åœ¨è¿è¡Œ";
          statusBadge.textContent = "ç³»ç»Ÿè¿è¡Œä¸­";
          statusBadge.classList.remove("off");
          statusBadge.classList.add("on");
        } else {
          toggleButton.classList.remove("on");
          toggleButton.classList.add("off");
          btnText.textContent = "ç‚¹å‡»å¯åŠ¨";
          statusBadge.textContent = "ç³»ç»Ÿå·²å…³é—­";
          statusBadge.classList.remove("on");
          statusBadge.classList.add("off");
        }
      }

      // å°è£…åˆ‡æ¢ç³»ç»Ÿå‡½æ•°
      async function toggleSystem() {
        const response = await fetch("/toggle", { method: "POST" });
        if (response.ok) {
          isOPEN = !isOPEN;
          updateUIState();

          if (!isOPEN) {
            document
              .getElementById("runningTimeDisplay")
              .classList.add("hidden");
            document.getElementById("timerDisplay").classList.add("hidden");
            lastTimerRemaining = -1;
          }
        } else {
          alert("âŒ åˆ‡æ¢å¤±è´¥ï¼");
        }
      }

      toggleButton.addEventListener("click", toggleSystem);

      // é¡µé¢åŠ è½½æ—¶è·å–å½“å‰å¼€å…³çŠ¶æ€
      async function getToggleState() {
        const response = await fetch("/toggle");
        if (response.ok) {
          const data = await response.json();
          isOPEN = data.status === "OPEN";
          updateUIState();
          // è·å–åˆ°å¼€å…³çŠ¶æ€åï¼Œç«‹å³æ›´æ–°æ—¶é—´æ˜¾ç¤º
          await getCurrentValues();
        } else {
          alert("âŒ æ— æ³•è·å–å¼€å…³çŠ¶æ€ï¼");
        }
      }

      // é¡µé¢åŠ è½½æ—¶è°ƒç”¨
      getToggleState();
    </script>
  </body>
</html>
