<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>ESP32 Embedded Page</title>
    <style>
      body {
        font-family: Arial, Helvetica, sans-serif;
        margin: 2rem;
      }
      .container {
        max-width: 600px;
        margin: 0 auto;
      }
      .form-group {
        margin-bottom: 1rem;
      }
      label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: bold;
      }
      input {
        width: 100%;
        padding: 0.5rem;
        box-sizing: border-box;
      }
      button {
        background-color: #4caf50;
        color: white;
        padding: 0.75rem 1.5rem;
        border: none;
        cursor: pointer;
        font-size: 1rem;
      }
      button:hover {
        background-color: #45a049;
      }
      .values {
        margin-top: 2rem;
        padding: 1rem;
        background-color: #f5f5f5;
        border-radius: 5px;
      }
      .value-item {
        margin: 0.5rem 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ESP32 PID 参数配置</h1>

      <form id="configForm">
        <div class="form-group">
          <label for="P_value">P 值:</label>
          <input type="number" id="P_value" step="0.01" value="0.0" />
        </div>
        <div class="form-group">
          <label for="I_value">I 值:</label>
          <input type="number" id="I_value" step="0.01" value="0.0" />
        </div>
        <div class="form-group">
          <label for="D_value">D 值:</label>
          <input type="number" id="D_value" step="0.01" value="0.0" />
        </div>
        <button type="submit">提交配置</button>
      </form>

      <div class="values">
        <h3>当前值:</h3>
        <div class="value-item">P: <span id="current_P">0.00</span></div>
        <div class="value-item">I: <span id="current_I">0.00</span></div>
        <div class="value-item">D: <span id="current_D">0.00</span></div>
        <div class="value-item">
          <strong>循环计数:</strong> <span id="current_i">0</span>
        </div>
      </div>
    </div>

    <script>
      // 提交配置
      document
        .getElementById("configForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();
          const P = document.getElementById("P_value").value;
          const I = document.getElementById("I_value").value;
          const D = document.getElementById("D_value").value;

          const response = await fetch("/config", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              P: parseFloat(P),
              I: parseFloat(I),
              D: parseFloat(D),
            }),
          });

          if (response.ok) {
            alert("配置成功!");
          } else {
            alert("配置失败!");
          }
        });

      // 获取当前值
      async function getCurrentValues() {
        const response = await fetch("/values");
        const data = await response.json();
        document.getElementById("current_P").textContent = data.P.toFixed(2);
        document.getElementById("current_I").textContent = data.I.toFixed(2);
        document.getElementById("current_D").textContent = data.D.toFixed(2);
        document.getElementById("current_i").textContent = data.i;
      }

      // 页面加载时获取当前 PID 数据并设置默认值
      async function setDefaultValues() {
        const response = await fetch("/values");
        const data = await response.json();
        document.getElementById("P_value").value = data.P.toFixed(2);
        document.getElementById("I_value").value = data.I.toFixed(2);
        document.getElementById("D_value").value = data.D.toFixed(2);
      }

      // 调用函数设置默认值
      setDefaultValues();

      // 定时刷新
      getCurrentValues();
      setInterval(getCurrentValues, 1000);
    </script>
  </body>
</html>
